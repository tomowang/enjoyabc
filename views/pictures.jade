extends layout

block content
  .page.thirdary
    include includes/header
    .page-region
      .page-region-content
        .image-collection
          each p in pictures
            div
              img(src="/pool/#{p}")
              - if (role === 'admin') {
                a.icon-cancel.top-right(href="#", data-filename="#{p}")
              - }
        - if (role === 'admin') {
          a#upload.place-left.bg-color-blue51.icon-upload-3(href="#")
        - }
    //-include includes/footer

  - if (role === 'admin') {
    .dialog.modal#upload_popup
      .modal-header Upload pictures
        i.icon-cancel.close
      .modal-content
        .alert.bg-color-red
          span
          i.icon-cancel
        form.box#fileupload(action="/pictures", method="POST", enctype="multipart/form-data")
          .progress-bar
            .bar.bg-color-red
          .input-control
            input#pictures(name="pictures", required="required", type='file', accept="images/*", multiple)
          button.bg-color-blue.fg-color-white#uploadbtn(type="submit") Upload
          a.button.close.bg-color-red.fg-color-white#cancel Cancel
  - }

block js
  - if (role === 'admin') {
    script(type='text/javascript').
      ;(function($){
        $(document).ready(function(e){
          var popup = $('#upload_popup');
          $('#upload').click(function(e){
            $('.alert', popup).hide();
            popup.lightbox_me();          
          });
          $('form').ajaxForm({
            dataType: 'json',
            beforeSerialize: function($form, options){
            },
            beforeSubmit: function(formData, jqForm, options){
              var $form = jqForm[0];
              $('.close', $form).addClass('disabled').attr('disabled', 'disabled');
              $('.bar', $form).css('width', '0%');
            },
            uploadProgress: function(e, position, total, done){
              $('.bar', popup).css('width', done + '%');
            },
            success: function(data){
              window.location.href = '/pictures';
            },
            error: function(jqXHR, textStatus, errorThrown){
              $('.close', popup).removeAttr('disabled').removeClass('disabled');
              var rt = jqXHR.responseText
                , jsrt = {};
              try{
                jsrt = $.parseJSON(rt);
              }catch(e){
              }
              if(jsrt.error){
                $('.alert span', popup).html(jsrt.error);
                $('.alert', popup).show();
              }
            }
          });
          $('.alert .icon-cancel').click(function(e){
            $(this).parent('.alert').hide();
          });
          $('a.icon-cancel').click(function(e){
            var _this = $(this);
            $.ajax({
              url: '/pictures/' + _this.data('filename'),
              type: 'DELETE',
              success: function(data){
                _this.parent('div').remove();
              }
            });
          });
        });
      })(jQuery);
  - }

append scripts
  script(src='/javascript/jquery.lightbox_me.js', text='text/javascript')
  script(src='/javascript/jquery.form.js', text='text/javascript')
